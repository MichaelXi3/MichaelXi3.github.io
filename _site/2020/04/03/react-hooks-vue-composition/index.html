<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 @Hux黄玄 的个人博客，与你一起发现更大的世界 | 要做一个有 swag 的程序员">
    <meta name="keywords" content="黄玄, Hux黄玄, Hux, 鬼栈, huxpro, @huxpro, 黄玄的博客, Hux Blog, 博客, 个人网站, 互联网, Web, JavaScript, React, React Native, 前端, 设计">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="React Hooks 是否可以改为用类似 Vue 3 Composition API 的方式实现？ - 黄玄的博客 | Hux Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="
  这篇文章转载自我在知乎上的回答

">
    
    <meta property="article:published_time" content=" 2020-04-03T00:00:00Z">
    
    
    <meta property="article:author" content="Hux">
    
    
    <meta property="article:tag" content="知乎">
    
    <meta property="article:tag" content="Web">
    
    <meta property="article:tag" content="React">
    
    
    <meta property="og:image" content="http://localhost:4000https://github.com/Huxpro.png">
    <meta property="og:url" content="http://localhost:4000/2020/04/03/react-hooks-vue-composition/">
    <meta property="og:site_name" content="黄玄的博客 | Hux Blog">

    <title>React Hooks 是否可以改为用类似 Vue 3 Composition API 的方式实现？ - 黄玄的博客 | Hux Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2020/04/03/react-hooks-vue-composition/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Hux Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>




<header class="intro-header style-text" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E7%9F%A5%E4%B9%8E" title="知乎">知乎</a>
                        
                        <a class="tag" href="/archive/?tag=Web" title="Web">Web</a>
                        
                        <a class="tag" href="/archive/?tag=React" title="React">React</a>
                        
                    </div>
                    <h1>React Hooks 是否可以改为用类似 Vue 3 Composition API 的方式实现？</h1>
                    
                    <h2 class="subheading">Thinking in React vs. Thinking in Vue</h2>
                    <span class="meta">Posted by Hux on April 3, 2020</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<blockquote>
  <p>这篇文章转载自<a href="https://www.zhihu.com/question/378861485/answer/1125724740">我在知乎上的回答</a></p>
</blockquote>

<p><strong>不能，因为是很不一样的<a href="https://www.zhihu.com/search?q=%E5%BF%83%E6%99%BA%E6%A8%A1%E5%9E%8B&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A1125724740%7D">心智模型</a>（Mental Model）。</strong>我觉得很多同学只关注到了这两套 API 在功能上都能复用逻辑的相似点，而低估了两个框架体系「大背景」上的差异。</p>

<p>正文开始前我先声明一下，</p>

<ol>
  <li>
    <p>一是本文观点不代表公司。我是觉得圈子里不认同 Hooks 的声音太多了（比如 <a href="//www.zhihu.com/people/c5198d4e9c0145aee04dd53cc6590edd">@徐飞</a> 叔叔、 <a href="//www.zhihu.com/people/3ec3b166992a5a90a1083945d2490d38">@贺师俊</a> 贺老、 <a href="//www.zhihu.com/people/790dccce26904cdcd11b0fad3bac37b7">@题叶</a> 同学等老朋友 no offensive），所以自愿出来平衡一下。</p>
  </li>
  <li>
    <p>二是我确实好久没有实际写前端了 ，React Hooks 实战还不多，Vue 3 只草草略读了 <a href="https://link.zhihu.com/?target=https%3A//vue-composition-api-rfc.netlify.com/">Composition API RFC</a> 与之前中文的 <a href="https://zhuanlan.zhihu.com/p/68477600">Vue Function-based API RFC</a>（所以对细节并不太熟悉。）欢迎大家务必指正、补充（与要求补充）。</p>
  </li>
</ol>

<h2 id="引言">引言</h2>

<p>「框架/库是编程语言上的抽象」，并不意味着框架的设计就无法跳脱出其实现语言的习语（idioms）与编程范式（paradiams）。</p>

<p>得益于 JavaScript 几个非常 Lisp 的特点：一等公民函数、动态类型、一定的宏支持（比如 Babel），这几年<a href="https://www.zhihu.com/search?q=%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A1125724740%7D">前端框架</a>的发展可以看到很多编程语言设计的思路：框架成为了由 DSL 与 API 构成的特定语法（syntax）、从 JavaScript 中扬弃以及由 API 附加的语义（semantics）、支撑这套体系运作的运行时（runtime）、以及所表达的心智模型（<a href="https://www.zhihu.com/search?q=mental+model&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A1125724740%7D">mental model</a>）的结合。</p>

<h2 id="vue-3-reactive-closure-based-oop">Vue 3, “Reactive (Closure-based) OOP”</h2>

<p>先来看 Vue（本文中的 Vue 主要指使用 Composition API 下的 Vue）</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">Counter</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nf">setup</span><span class="p">(</span><span class="nx">initialProps</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="nf">reactive</span><span class="p">({</span><span class="na">count</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span> <span class="c1">// or `ref(0)`</span>
    <span class="kd">const</span> <span class="nx">inc</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="o">++</span> <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">count</span><span class="p">,</span> <span class="nx">inc</span><span class="p">}</span>
  <span class="p">}</span>
  <span class="nl">template</span><span class="p">:</span> <span class="dl">"</span><span class="s2">...</span><span class="dl">"</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Vue 为组件挑选的语义是「对象」：Composition API 的<code class="language-plaintext highlighter-rouge">setup</code> 只会调用一次并返回一个对象合并到 <code class="language-plaintext highlighter-rouge">Counter</code> 组件上，这个对象与其成员全都是持久的引用，包括保存在 <code class="language-plaintext highlighter-rouge">inc</code> 闭包中的状态 <code class="language-plaintext highlighter-rouge">count</code> 也是持久的。渲染则是对组件上的<code class="language-plaintext highlighter-rouge">template</code> 域的具象化。</p>

<p>Vue 附加的核心语义是（基于可变数据的）「响应式（reactive）」：状态 <code class="language-plaintext highlighter-rouge">count</code> 是一个响应式对象，<code class="language-plaintext highlighter-rouge">inc</code> 进行状态更改的方式是对 <code class="language-plaintext highlighter-rouge">count</code> 直接修改，状态更改的结果是执行所有观察者（watcher）的逻辑，包括重渲染和执行副作用（<code class="language-plaintext highlighter-rouge">watchEffect</code>) ，都是基于这个语义纳入数据流。</p>

<p>有的同学（比如题主）说，如果改成返回一个 <code class="language-plaintext highlighter-rouge">render</code> 函数，<strong>直接利用闭包来保存组件变量</strong>，你还说这是对象的语义吗？</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">return </span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">inc</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><em>是的</em>。Vue 的实现需要保持这个函数与其闭包的引用不变（referential identity）来满足状态被持久化的语义，是 JavaScript 用闭包模拟对象私有属性的经典模式<a href="#ref_1">[1]</a>。（「闭包是穷人的对象，对象是穷人的闭包」）</p>

<p>为了帮助你理解，如果我们有一门假想的 Vue 语言的话……</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">// hypothetical Vue lang</span>
<span class="nx">component</span> <span class="nc">Counter </span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// constructor</span>
  <span class="p">@</span><span class="nd">reactive</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1">// field</span>
  <span class="nf">inc</span><span class="p">()</span> <span class="p">{</span> <span class="nx">count</span><span class="p">.</span><span class="nx">value</span> <span class="o">++</span> <span class="p">}</span>     <span class="c1">// method</span>
  <span class="nf">render</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">inc</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">.</span><span class="nx">value</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/a&gt; </span><span class="err">}
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>是不是有基于类的 OOP 内味了？只不过 Vue 的对象是基于单例（或者闭包）而非类（或原型）实现，以及成员是被施过 reactive 魔法哒！这里我们展示了如何从概念上将 Vue 归约到 OOP 的心智模型，不过需要注意得是，Vue 整个体系（考虑状态管理、<a href="https://www.zhihu.com/search?q=%E6%95%B0%E6%8D%AE%E6%B5%81%E6%8E%A7%E5%88%B6&amp;search_source=Entity&amp;hybrid_search_source=Entity&amp;hybrid_search_extra=%7B%22sourceType%22%3A%22answer%22%2C%22sourceId%22%3A1125724740%7D">数据流控制</a>）的心智模型有很多 FP 的东西在里面，仍然和传统观念（比如 Java）的 OOP 有很大差别，<a href="#ref_2">[2]</a><a href="#ref_3">[3]</a>。</p>

<p>Vue 运行时的核心是 dependency tracking（依赖追踪），首先它使得 reactive 语义对用户相对 implicit（隐式），依赖都是自动收集的，大大降低了用户的心智负担。其次呢它非常细的跟踪粒度配合 Vue 使用静态化程度比较高模板使得重渲染自动就可以做到非常精准。</p>

<p>总结起来，Vue 在组件方面的心智模型仍然是「拥有数据与行为且自响应式的对象」，只要照着这个思路去想，就比较好理解「为什么 Vue 的状态可以使用可变数据结构」、「为什么 Vue 需要<code class="language-plaintext highlighter-rouge">ref</code> 包装值类型」，以及 RFC 在对比 React Hooks 时提到的「为什么 Vue 更接近大家习惯的 JS 」（这点比较主观就是了）、「为什么 Vue 的 GC 压力会更小」、「为什么 Vue 不需要手动声明依赖」等优势的由来了。</p>

<h2 id="react-purely-semi-monadicalgebraic-fp">React, “Purely (Semi-Monadic/Algebraic) FP”</h2>

<p>再来看 React（本文中的 React 主要指 Hooks API 下的 React）</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">Counter</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nf">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">inc</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">setCount</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">inc</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>React 为组件挑选的语义是「函数」，每次渲染都是对 <code class="language-plaintext highlighter-rouge">Counter</code> 这个函数的一次真实调用。每次 <code class="language-plaintext highlighter-rouge">useState</code> 都会执行并从 React 那取出当前的状态给 <code class="language-plaintext highlighter-rouge">count</code>，每次也都会创建一个新的 <code class="language-plaintext highlighter-rouge">inc</code> 函数（故其闭包中捕获的也是新的 <code class="language-plaintext highlighter-rouge">count</code> 值）。</p>

<p>React 附加的核心语义是一个副作用受控的「执行上下文（evaluation context）」，通俗得说就是 React 这个运行环境：状态 <code class="language-plaintext highlighter-rouge">count</code> 每次都要从 React 上下文中取出，<code class="language-plaintext highlighter-rouge">inc</code> 对状态更改的方式是用 <code class="language-plaintext highlighter-rouge">setCount</code> 更新上下文里的内容，状态更改的结果是这个函数会被重新调用，调用时函数就会从新的上下文中获得新的状态、进行重渲染和安排上（schedule）受上下文控制的副作用（<code class="language-plaintext highlighter-rouge">useEffect</code>) 。</p>

<p>为了帮助你理解，如果我们有一门假想的 React 语言的话……</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1">// hypothetical React lang Ⅰ</span>
<span class="nx">component</span> <span class="nx">Counter</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span>      <span class="c1">// function</span>
  <span class="p">@</span><span class="nd">context</span><span class="p">.</span><span class="nf">state</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>                  <span class="c1">// context provides `get_or` and `put`</span>
    <span class="nx">count</span> <span class="o">&lt;-</span> <span class="nf">get_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>              <span class="c1">// get from context (or use default value)</span>
    <span class="kd">let</span> <span class="nx">inc</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">put</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">// callback can update the context</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">inc</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span>  <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>是不是有基于 Monad 的 Haskell 内味了？只不过 React 把 API 做得完全不需要你弄懂这些复杂的东西<a href="#ref_4">[4]</a>。如果你不熟悉 Monad 这个纯 FP 的概念，我们可以先不严谨<a href="#ref_5">[5]</a>得把它当做文中的「上下文」。扔出 M-bomb 的原因是大家通常把它作为在纯 FP 中处理副作用的标杆，帮助我们展示如何把 React 归约到纯 FP。</p>

<p>有的同学（比如<a href="//www.zhihu.com/people/790dccce26904cdcd11b0fad3bac37b7">@题叶</a>）会疑惑，这怎么跟我认得的「纯函数」不一样呢，这也是「纯函数式编程」吗？其实如果我们把语法糖展开就会变成：</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nx">component</span> <span class="nx">Counter</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span>
  <span class="nx">context</span><span class="p">.</span><span class="nf">state</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nf">get_or</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nf">then</span><span class="p">([</span><span class="nx">count</span><span class="p">,</span> <span class="nx">put</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="p">{</span>  <span class="c1">// `then` is monadic bind.</span>
    <span class="kd">let</span> <span class="nx">inc</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nf">put</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClock</span><span class="o">=</span><span class="p">{</span><span class="nx">inc</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span>  <span class="p">}).</span><span class="nf">unwrap</span><span class="p">()</span> <span class="c1">// assuming it's safe.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>有没有想到同样被称作 Monad，具备异步上下文的 Promise？</p>

<p>再（过度）简化一些，你可以想象成最直白的 state-passing 风格（实际上 2018 年时 React 团队就这么考虑过类似的 API <a href="#ref_6">[6]</a>，也是 Seb 的理论基础之一<a href="#ref_7">[7]</a>）:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="nx">component</span> <span class="nx">Counter</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="nx">stateMap</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">stateMap</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">or</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">inc</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">stateMap</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// functional update</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">inc</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>不过，React 从实现到 API 设计都更靠近与追求<a href="#ref_8">[8]</a>的心智模型是一个相对较新的纯 FP 概念 —— Algebraic Effect（代数作用），虽然名字听起来相当迷惑，但其实它在描述副作用上比 Monad 反而更不花哨（少一些 ceremony），理解起来也更加容易，Dan 有一篇给 JSer 看的很易懂的博文<a href="#ref_9">[9]</a>并且有中文翻译<a href="#ref_10">[10]</a>。我们可以先把它当作「可以重新恢复的 <code class="language-plaintext highlighter-rouge">try-catch</code> 」</p>

<p>为了帮助你理解，如果我们又又又又有一门假想的 React 语言的话……</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// hypothetical React lang Ⅱ</span>
<span class="nx">component</span> <span class="nx">Counter</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">perform</span> <span class="nf">getState</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nx">or</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// 1. `perform` "throw" effects to the context</span>
                                                <span class="c1">// 4. resume with the continuation to here</span>
  <span class="kd">let</span> <span class="nx">inc</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">perform</span> <span class="nf">putState</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">s</span><span class="o">=</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">inc</span><span class="p">}</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">count</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span><span class="p">}</span>

<span class="c1">// call site</span>
<span class="k">try</span> <span class="o">&lt;</span><span class="nx">Counter</span> <span class="o">/&gt;</span> <span class="nx">handle</span>  <span class="c1">// 2.try-handle pattern match effects</span>
                        <span class="c1">// 3. get state from the context and then resume</span>
<span class="o">|</span> <span class="nf">getState</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">or</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">resume</span> <span class="kd">with</span> <span class="nx">context</span><span class="p">.</span><span class="nf">state</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">??</span> <span class="nx">or</span>
<span class="o">|</span> <span class="nf">putState</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">context</span><span class="p">.</span><span class="nf">state</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="o">=</span><span class="nx">s</span><span class="p">;</span> <span class="nx">resume</span> <span class="kd">with</span> <span class="k">void</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>是不是有感觉一些了？我们从组件里「扔出去」去更改 「执行上下文」里的状态，然后再「恢复」回来……</p>

<p>即便 React 已经很努力的降低了 API 的门槛，但其思维的愈加纯函数式确实会在更多程序员眼里非常「离经叛道」。</p>

<p>所以为什么我们需要「纯函数式编程」？抛开大家可能已经熟悉的声明式、数据流清晰、局部推理、易于组合外，其背后的学术理论支撑使得其在编译期静态分析与优化、运行时高并发高并行友好方面都有极高的理论上限和上升空间（近年编程原理的理论研究完全是被函数式编程霸占得）</p>

<p>React 现在运行时侧重的核心是 cooperative multitasking（协作式多任务），来为 React 加入 concurrency（并发）、schedule（调度）等底层能力。很多同学只听说过后端的高并发，其实像多任务操作系统这样的「终极 UI」就是一个高并发且依赖诸如分时（time-slicing）、优先处理（re-priortizing）等进程调度的场景。React 希望把这些技术带给 UI 开发者（比如 Suspense，比如 Selective Hydration，比如 RN 新架构中的 Fabrics），第一步是运行时用 Fiber 架构重写不依赖原生调用栈，第二步就是用 Hooks 解决 Class API 在纯度上约束力不够的问题。不纯的组件在 React 并发模式下很容易出现数据竞态（data race）的问题。</p>

<p>总结起来，React 在组件方面的心智模型是「副作用受上下文托管的纯函数」，只要照着这个思路去想，就比较好理解「为什么 React 中倾向于使用不可变数据结构」、「为什么 useEffect 默认会执行 cleanup 来保持幂等性」、「为什么 React 需要 <code class="language-plaintext highlighter-rouge">useRef</code> 这样的跨渲染 ref cell 机制来做 mutable ref 」、「为什么 React 的性能优化是 <code class="language-plaintext highlighter-rouge">useMemo</code>, <code class="language-plaintext highlighter-rouge">Memo</code> 这样 FP 风格的 memoization 」、「为什么 React 需要 <code class="language-plaintext highlighter-rouge">useMemo</code> <code class="language-plaintext highlighter-rouge">useCallback</code> 来保持 referential identity 」、「为什么 React 需要用依赖列表来进行 cache invalidation」等问题了。</p>

<h2 id="补充">补充</h2>

<p>2016 年底时我就觉得 React 和 Vue 的（一个）终极区别在于「可变」还是「不可变」。</p>

<p><img src="https://pica.zhimg.com/50/v2-22e50932c60262bf381456de3017b217_720w.jpg?source=1940ef5c" alt="" /></p>

<p>Seb 在 Hooks 发布后收到一些质疑的 brain dump<a href="#ref_11">[11]</a> 里写到：</p>

<blockquote>
  <p>It’s interesting because there are really two approaches evolving. There’s a <strong>mutable + change tracking</strong> approach and there’s an <strong>immutability + referential equality testing</strong> approach. It’s difficult to mix and match them when you build new features on top. So that’s why React has been pushing a bit harder on immutability lately to be able to build on top of it. Both have various tradeoffs but others are doing good research in other areas, so we’ve decided to focus on this direction and see where it leads us.</p>
</blockquote>

<p>不全部翻译了，说得是整个「大前端」社区里最主要的两条道路分歧：</p>

<ul>
  <li>可变 + 变更追踪。包括 Vue，Angular，</li>
  <li>不可变 + 引用相等性。包括 React，Elm，(Flutter?)</li>
</ul>

<p>这个分歧其实与我之前行文的侧重点「为组件挑选的语义」其实是对偶的：</p>

<ul>
  <li>前者是对传统 Imperative Programming（包括 OOP）思路的一种增强，加入了 Reactivity。</li>
  <li>后者则是传统 Functional Programming 在 UI 开发领域的发扬光大（Functional Reactive Programming?)，只不过 React 是用一种比较「超越 JS 语言」的方式去实现得。</li>
</ul>

<p>这两条道路从底子就很不同，所以才造成了 React 和 Vue 在大家眼里的渐行渐远吧。</p>

<p>不过最近多看了一些 Svelte、 SwiftUI<a href="#ref_12">[12]</a>和 Jetpack Compose<a href="#ref_13">[13]</a>也开始有了一些殊途同归的感觉，Props 无论是跟着 View 销毁还是函数参数总是暂时性的输入，States 无论跟着组件实例还是置外总必须是持久化的，至于怎么判断更新，像 <code class="language-plaintext highlighter-rouge">array.push</code> 这种 mutable state 的场景总是不好 track 得，于是就只能各显神通了：React 想通过 reference equality 自动、Vue 3 想通过 Proxy 自动，但其实只要能把 change set 搞出来就行，Vue2/Svelte/SwiftUI/Compose 这些让用户手动给提示得不是也工作得好好得吗？只要能把变更集算出来传递给视图层，那视图层就只管更新（rerender/rebuild/recomposite）就是了。</p>

<h2 id="补充-2">补充 2</h2>

<p>如果是在重度依赖 Flux (Vuex/Redux, whatever) 的场景，可能 Vue/React 会更像是一个只负责渲染的 dumb/passive layer，这种时候上文说的 Vue/React 的差异会显得不明显，因为大部分的状态管理（state management）都已经扔到更外层去做了。</p>

<p>不过，考虑需要组件内聚的场景（即组件自己有私有状态，需要 self-conatined）以及 React Hooks / Vue Composition APIs 开始接管更多（除状态之外的，比如 IO）副作用，这种差异只会变得越来越明显得。</p>

<p>以上。</p>

<h2 id="参考">参考</h2>

<ol>
  <li>JavaScript 模块化七日谈 - 黄玄的博客 Hux Blog <a href="https://huangxuan.me/2015/07/09/js-module-7day/">https://huangxuan.me/2015/07/09/js-module-7day/</a></li>
  <li>如何理解尤雨溪在 2019 VueConf 上所讲的 UI 类框架很少使用面向对象的特性这件事？- 黄玄的回答 <a href="https://www.zhihu.com/question/328958700/answer/714287394">https://www.zhihu.com/question/328958700/answer/714287394</a></li>
  <li>前端是否适合使用面向对象的方式编程？- 黄玄的回答 <a href="https://www.zhihu.com/question/329005869/answer/739525268">https://www.zhihu.com/question/329005869/answer/739525268</a></li>
  <li>React Hooks的引入会对之后的React项目开发产生什么影响？- 黄玄的回答 <a href="https://www.zhihu.com/question/302916879/answer/536846510">https://www.zhihu.com/question/302916879/answer/536846510</a></li>
  <li>React 上下文的组合是通过调用顺序在运行时里维护一个链表而非基于参数化多态的层叠（比如 Monad Transformer）来表达，可以看到都是线性的。</li>
  <li>State-passing Style Hooks <a href="https://mobile.twitter.com/acdlite/status/971598256454098944">https://mobile.twitter.com/acdlite/status/971598256454098944</a></li>
  <li><a href="https://github.com/reactjs/react-basic">https://github.com/reactjs/react-basic</a></li>
  <li>可以把上下文或者 Hooks 的调用视为一次 stack unwinding + resume continuation。同样，考虑 row polymorphism 也是线性的。</li>
  <li>Algebraic Effects for the Rest of Us <a href="https://overreacted.io/algebraic-effects-for-the-rest-of-us/">https://overreacted.io/algebraic-effects-for-the-rest-of-us/</a></li>
  <li>通俗易懂的代数效应 <a href="https://overreacted.io/zh-hans/algebraic-effects-for-the-rest-of-us/">https://overreacted.io/zh-hans/algebraic-effects-for-the-rest-of-us/</a></li>
  <li>Why React <a href="https://gist.github.com/sebmarkbage/a5ef436427437a98408672108df01919">https://gist.github.com/sebmarkbage/a5ef436427437a98408672108df01919</a></li>
  <li><a href="https://swiftwithmajid.com/2019/06/12/understanding-property-wrappers-in-swiftui/">https://swiftwithmajid.com/2019/06/12/understanding-property-wrappers-in-swiftui/</a></li>
  <li><a href="https://developer.android.com/jetpack/compose/state#remember">https://developer.android.com/jetpack/compose/state#remember</a></li>
</ol>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2019/11/19/is-pwa-dead-in-2019/" data-toggle="tooltip" data-placement="top" title="2019 年 PWA(Progressive Web App) 凉了吗？">
                        Previous<br>
                        <span>2019 年 PWA(Progressive Web App) 凉了吗？</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2020/05/05/pl-chart/" data-toggle="tooltip" data-placement="top" title="My Programming Languages Spectrum">
                        Next<br>
                        <span>My Programming Languages Spectrum</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0065" 
                    href="/archive/?tag=%E7%9F%A5%E4%B9%8E"
                    title="知乎"
                    rel="14">知乎</a>
        
                <a data-sort="0039" 
                    href="/archive/?tag=%E7%AC%94%E8%AE%B0"
                    title="笔记"
                    rel="40">笔记</a>
        
                <a data-sort="0043" 
                    href="/archive/?tag=Coq"
                    title="Coq"
                    rel="36">Coq</a>
        
                <a data-sort="0043" 
                    href="/archive/?tag=SF+%28%E8%BD%AF%E4%BB%B6%E5%9F%BA%E7%A1%80%29"
                    title="SF (软件基础)"
                    rel="36">SF (软件基础)</a>
        
                <a data-sort="0057" 
                    href="/archive/?tag=Web"
                    title="Web"
                    rel="22">Web</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=PLF+%28%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%29"
                    title="PLF (编程语言基础)"
                    rel="19">PLF (编程语言基础)</a>
        
                <a data-sort="0063" 
                    href="/archive/?tag=LF+%28%E9%80%BB%E8%BE%91%E5%9F%BA%E7%A1%80%29"
                    title="LF (逻辑基础)"
                    rel="16">LF (逻辑基础)</a>
        
                <a data-sort="0071" 
                    href="/archive/?tag=PWA"
                    title="PWA"
                    rel="8">PWA</a>
        
                <a data-sort="0073" 
                    href="/archive/?tag=%E4%BA%A7%E5%93%81"
                    title="产品"
                    rel="6">产品</a>
        
                <a data-sort="0073" 
                    href="/archive/?tag=UX%2FUI"
                    title="UX/UI"
                    rel="6">UX/UI</a>
        
                <a data-sort="0075" 
                    href="/archive/?tag=JavaScript"
                    title="JavaScript"
                    rel="4">JavaScript</a>
        
                <a data-sort="0075" 
                    href="/archive/?tag=Meta"
                    title="Meta"
                    rel="4">Meta</a>
        
                <a data-sort="0075" 
                    href="/archive/?tag=Slides"
                    title="Slides"
                    rel="4">Slides</a>
        
                <a data-sort="0076" 
                    href="/archive/?tag=%E8%AF%91"
                    title="译"
                    rel="3">译</a>
        
                <a data-sort="0076" 
                    href="/archive/?tag=%E9%98%BF%E9%87%8C"
                    title="阿里"
                    rel="3">阿里</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=%E5%9F%BA%E7%A1%80"
                    title="基础"
                    rel="2">基础</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=%E5%BE%AE%E4%BF%A1"
                    title="微信"
                    rel="2">微信</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=%E8%AE%A1%E7%AE%97%E7%90%86%E8%AE%BA"
                    title="计算理论"
                    rel="2">计算理论</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=C"
                    title="C"
                    rel="2">C</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=C%2B%2B"
                    title="C++"
                    rel="2">C++</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=CSS"
                    title="CSS"
                    rel="2">CSS</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=En"
                    title="En"
                    rel="2">En</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=Vim"
                    title="Vim"
                    rel="2">Vim</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=hUX+%E9%9A%8F%E6%83%B3%E5%BD%95"
                    title="hUX 随想录"
                    rel="2">hUX 随想录</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="http://mida.re/">乱序（Midare）</a></li>
  
  <li><a href="https://ebnbin.dev/">Ebn Zhang</a></li>
  
  <li><a href="http://kunq.me">Kun Qian</a></li>
  
  <li><a href="https://sherrywoo.me/">Sherry Woo</a></li>
  
  <li><a href="http://blog.smdcn.net">SmdCn</a></li>
  
  <li><a href="http://tiye.me/">JiyinYiyong</a></li>
  
  <li><a href="http://dhong.co">DHong Say</a></li>
  
  <li><a href="http://ingf.github.io/">尹峰以为</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "hux";
    var disqus_identifier = "/2020/04/03/react-hooks-vue-composition";
    var disqus_url = "http://localhost:4000/2020/04/03/react-hooks-vue-composition/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="http://weibo.com/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://github.com/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Hux Blog 2023
                    <br>
                    Powered by <a href="http://huangxuan.me">Hux Blog</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'huangxuan.me';

    // Originial
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
