<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 @Hux黄玄 的个人博客，与你一起发现更大的世界 | 要做一个有 swag 的程序员">
    <meta name="keywords" content="黄玄, Hux黄玄, Hux, 鬼栈, huxpro, @huxpro, 黄玄的博客, Hux Blog, 博客, 个人网站, 互联网, Web, JavaScript, React, React Native, 前端, 设计">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="How does SW-Precache works? - 黄玄的博客 | Hux Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="SW-Precache is a great Service Worker tool from Google. It is a node module designed to be integrated into your build process and to generate a service worker for you. Though you can use sw-precach...">
    
    <meta property="article:published_time" content=" 2017-05-28T00:00:00Z">
    
    
    <meta property="article:author" content="Hux">
    
    
    <meta property="article:tag" content="Web">
    
    <meta property="article:tag" content="PWA">
    
    <meta property="article:tag" content="En">
    
    
    <meta property="og:image" content="http://localhost:4000https://github.com/Huxpro.png">
    <meta property="og:url" content="http://localhost:4000/2017/05/28/sw-precache/">
    <meta property="og:site_name" content="黄玄的博客 | Hux Blog">

    <title>How does SW-Precache works? - 黄玄的博客 | Hux Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2017/05/28/sw-precache/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Hux Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>




<header class="intro-header style-text" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=Web" title="Web">Web</a>
                        
                        <a class="tag" href="/archive/?tag=PWA" title="PWA">PWA</a>
                        
                        <a class="tag" href="/archive/?tag=En" title="En">En</a>
                        
                    </div>
                    <h1>How does SW-Precache works?</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by Hux on May 28, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<p><a href="https://github.com/GoogleChrome/sw-precache"><em>SW-Precache</em></a> <em>is a great Service Worker tool from Google. It is a node module designed to be</em> <em>integrated</em> <em>into your build process and to generate a service worker for you.</em> <em>Though</em> <em>you can use sw-precache out of the box, you might still wonder what happens under the hood. There you go, this article is written for you!</em></p>

<blockquote>
  <p>This post was first published at <a href="https://medium.com/@Huxpro/how-does-sw-precache-works-2d99c3d3c725">Medium</a></p>
</blockquote>

<h2 id="overview">Overview</h2>

<p>The core files involving in sw-precache are mainly three:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>service-worker.tmpl  
lib/  
 ├ sw-precache.js  
 └ functions.js
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">sw-precache.js</code> is the main entry of the module. It reads the configuration, processes parameters, populates the <code class="language-plaintext highlighter-rouge">service-worker.tmpl</code> template and writes the result into specified file. And<code class="language-plaintext highlighter-rouge">functions.js</code> is just a module containing bunch of external functions which would be all injected into the generated service worker file as helpers.</p>

<p>Since the end effect of sw-precache is performed by the generated service worker file in the runtime, a easy way to get an idea of what happens is by checking out source code inside <code class="language-plaintext highlighter-rouge">service-worker.tmpl</code> . It’s not hard to understand the essentials and I will help you.</p>

<h2 id="initialization">Initialization</h2>

<p>The generated service worker file (let’s call it <code class="language-plaintext highlighter-rouge">sw.js</code> for instance) get configuration by text interpolation when <code class="language-plaintext highlighter-rouge">sw-precache.js</code> populating <code class="language-plaintext highlighter-rouge">service-worker.tmpl</code> .</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">// service-worker.tmpl  </span>
<span class="kd">var</span> <span class="nx">precacheConfig</span> <span class="o">=</span> <span class="o">&lt;%=</span> <span class="nx">precacheConfig</span> <span class="o">%&gt;</span><span class="p">;</span>

<span class="c1">// sw.js  </span>
<span class="kd">var</span> <span class="nx">precacheConfig</span> <span class="o">=</span> <span class="p">[</span>  
  <span class="p">[</span><span class="dl">"</span><span class="s2">js/a.js</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">3cb4f0</span><span class="dl">"</span><span class="p">],</span>   
  <span class="p">[</span><span class="dl">"</span><span class="s2">css/b.css</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">c5a951</span><span class="dl">"</span><span class="p">]</span>  
<span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>It’s not difficult to see that it’s a list of relative urls and MD5 hashes. In fact, one thing that <code class="language-plaintext highlighter-rouge">sw-precache.js</code> do in the build time is to calculate hash of each file that it asked to “precache” from <code class="language-plaintext highlighter-rouge">staticFileGlobs</code> parameter.</p>

<p>In <code class="language-plaintext highlighter-rouge">sw.js</code>, <code class="language-plaintext highlighter-rouge">precacheConfig</code> would be transformed into a ES6 Map with structure <code class="language-plaintext highlighter-rouge">Map {absoluteUrl =&gt; cacheKey}</code> as below. Noticed that I omit the origin part (e.g. <code class="language-plaintext highlighter-rouge">http://localhost</code>) for short.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nx">urlToCacheKeys</span>  
<span class="o">&lt;</span> <span class="nc">Map</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  
  <span class="dl">"</span><span class="s2">http.../js/a.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../js/a.js?_sw-precache=3cb4f0</span><span class="dl">"</span><span class="p">,</span>   
  <span class="dl">"</span><span class="s2">http.../css/b.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../css/b.css?_sw-precache=c5a951</span><span class="dl">"</span>  
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Instead of using raw URL as the cache key, sw-precache append a <code class="language-plaintext highlighter-rouge">_sw-precache=[hash]</code> to the end of each URL when populating, updating its cache and even fetching these subresouces. Those <code class="language-plaintext highlighter-rouge">_sw-precache=[hash]</code> are what we called <strong>cache-busting parameter*</strong>. It can prevent service worker from responding and caching out-of-date responses found in browsers’ HTTP cache indefinitely.</p>

<p>Because each build would re-calculate hashes and re-generate a new <code class="language-plaintext highlighter-rouge">sw.js</code> with new <code class="language-plaintext highlighter-rouge">precacheConfig</code> containing those new hashes, <code class="language-plaintext highlighter-rouge">sw.js</code> can now determine the version of each subresources thus decide what part of its cache needs a update. <strong>This is pretty similar with what we commonly do when realizing long-term caching with webpack or gulp-rev, to do a byte-diff ahead of runtime.</strong></p>

<p>*: Developer can opt out this behaviour with <code class="language-plaintext highlighter-rouge">dontCacheBustUrlsMatching</code> option if they set HTTP caching headers right. More details on <a href="https://jakearchibald.com/2016/caching-best-practices/">Jake’s Post</a>.</p>

<h2 id="on-install">On Install</h2>

<blockquote>
  <p>ServiceWorker gives you an install event. You can use this to get stuff ready, stuff that must be ready before you handle other events.</p>
</blockquote>

<p>During the <code class="language-plaintext highlighter-rouge">install</code> lifecycle, <code class="language-plaintext highlighter-rouge">sw.js</code> open the cache and get started to populate its cache. One cool thing that it does for you is its <strong>incremental update</strong> mechanism.</p>

<p>Sw-precache would search each cache key (the values of <code class="language-plaintext highlighter-rouge">urlsToCacheKeys</code>) in the <code class="language-plaintext highlighter-rouge">cachedUrls</code>, a ES6 Set containing URLs of all requests indexed from current version of cache, and only <code class="language-plaintext highlighter-rouge">fetch</code> and <code class="language-plaintext highlighter-rouge">cache.put</code> resources couldn’t be found in cache, i.e, never be cached before, thus reuse cached resources as much as possible.</p>

<p>If you can not fully understand it, don’t worry. We will recap it later, now let’s move on.</p>

<h2 id="on-activate">On Activate</h2>

<blockquote>
  <p>Once a new ServiceWorker has installed &amp; a previous version isn’t being used, the new one activates, and you get an <code class="language-plaintext highlighter-rouge">activate</code> event. Because the old version is out of the way, it’s a good time to handle schema migrations in IndexedDB and also delete unused caches.</p>
</blockquote>

<p>During activation phase, <code class="language-plaintext highlighter-rouge">sw.js</code> would compare all existing requests in the cache, named <code class="language-plaintext highlighter-rouge">existingRequests</code> (noticed that it now contains resources just cached on installation phase) with <code class="language-plaintext highlighter-rouge">setOfExpectedUrls</code>, a ES6 Set from the values of <code class="language-plaintext highlighter-rouge">urlsToCacheKeys</code>. And delete any requests not matching from cache.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c1">// sw.js</span>
<span class="nx">existingRequests</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">existingRequest</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nx">setOfExpectedUrls</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="nx">existingRequest</span><span class="p">.</span><span class="nx">url</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="nx">existingRequest</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="on-fetch">On Fetch</h2>

<p>Although the comments in source code have elaborated everything well, I wanna highlight some points during the request intercepting duration.</p>

<h3 id="should-respond">Should Respond?</h3>

<p>Firstly, we need to determine whether this request was included in our “pre-caching list”. If it was, this request should have been pre-fetched and pre-cached thus we can respond it directly from cache.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">// sw.js*  </span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span>      
<span class="nx">shouldRespond</span> <span class="o">=</span> <span class="nx">urlsToCacheKeys</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Noticed that we are matching raw URLs (e.g. <code class="language-plaintext highlighter-rouge">http://localhost/js/a.js</code>) instead of the hashed ones. It prevent us from calculating hashes at runtime, which would have a significant cost. And since we have kept the relationship in <code class="language-plaintext highlighter-rouge">urlToCacheKeys</code> it’s easy to index the hashed one out.</p>

<p><em>* In real cases, sw-precache would take <code class="language-plaintext highlighter-rouge">ignoreUrlParametersMatching</code> and <code class="language-plaintext highlighter-rouge">directoryIndex</code> options into consideration.</em></p>

<h3 id="navigation-fallback">Navigation Fallback</h3>

<p>One interesting feature that sw-precache provided is <code class="language-plaintext highlighter-rouge">navigationFallback</code>(previously <code class="language-plaintext highlighter-rouge">defaultRoute</code>), which detect navigation request and respond a preset fallback HTML document when the URL of navigation request did not exist in <code class="language-plaintext highlighter-rouge">urlsToCacheKeys</code>.</p>

<p>It is presented for SPA using History API based routing, allowing responding arbitrary URLs with one single HTML entry defined in <code class="language-plaintext highlighter-rouge">navigationFallback</code>, kinda reimplementing a Nginx rewrite in service worker*. Do noticed that service worker only intercept document (navigation request) inside its scope (and any resources referenced in those documents of course). So navigation towards outside scope would not be effected.</p>

<p><em>* <code class="language-plaintext highlighter-rouge">navigateFallbackWhitelist</code> can be provided to limit the “rewrite” scope.</em></p>

<h3 id="respond-fromcache">Respond from Cache</h3>

<p>Finally, we get the appropriate cache key (the hashed URL) by raw URL with <code class="language-plaintext highlighter-rouge">urlsToCacheKeys</code> and invoke <code class="language-plaintext highlighter-rouge">event.respondWith()</code> to respond requests from cache directly. Done!</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c1">// sw.js*</span>
<span class="nx">event</span><span class="p">.</span><span class="nf">respondWith</span><span class="p">(</span>
  <span class="nx">caches</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">cacheName</span><span class="p">).</span><span class="nf">then</span><span class="p">(</span><span class="nx">cache</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">urlsToCacheKeys</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">url</span><span class="p">))</span>
      <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nf">if </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">})</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><em>* The code was “ES6-fied” with error handling part removed.</em></p>

<h2 id="cache-management-recap">Cache Management Recap</h2>

<p>That’s recap the cache management part with a full lifecycle simulation.</p>

<h3 id="the-firstbuild">The first build</h3>

<p>Supposed we are in the very first load, the <code class="language-plaintext highlighter-rouge">cachedUrls</code> would be a empty set thus all subresources listed to be pre-cached would be fetched and put into cache on SW install time.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c1">// cachedUrls  </span>
<span class="nc">Set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

<span class="c1">// urlToCacheKeys  </span>
<span class="nc">Map</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  
  <span class="dl">"</span><span class="s2">http.../js/a.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../js/a.js?_sw-precache=3cb4f0</span><span class="dl">"</span><span class="p">,</span>   
  <span class="dl">"</span><span class="s2">http.../css/b.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../css/b.css?_sw-precache=c5a951</span><span class="dl">"</span>  
<span class="p">}</span>

<span class="c1">// SW Network Logs  </span>
<span class="p">[</span><span class="nx">sw</span><span class="p">]</span> <span class="nx">GET</span> <span class="nx">a</span><span class="p">.</span><span class="nx">js</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="mi">3</span><span class="nx">cb4f0</span>      
<span class="p">[</span><span class="nx">sw</span><span class="p">]</span> <span class="nx">GET</span> <span class="nx">b</span><span class="p">.</span><span class="nx">css</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="nx">c5a951</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After that, it will start to control the page immediately because the <code class="language-plaintext highlighter-rouge">sw.js</code> would call <code class="language-plaintext highlighter-rouge">clients.claim()</code> by default. It means the <code class="language-plaintext highlighter-rouge">sw.js</code> will start to intercept and try to serve future fetches from caches, so it’s good for performance.</p>

<p>In the second load, all subresouces have been cached and will be served directly from cache. So none requests are sent from <code class="language-plaintext highlighter-rouge">sw.js</code>.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1">// cachedUrls  </span>
<span class="nc">Set</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  
  <span class="dl">"</span><span class="s2">http.../js/a.js? _sw-precache=3cb4f0</span><span class="dl">"</span><span class="p">,</span>   
  <span class="dl">"</span><span class="s2">http.../css/b.css? _sw-precache=c5a951</span><span class="dl">"</span>  
<span class="p">}</span>

<span class="c1">// urlToCacheKeys  </span>
<span class="nc">Map</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  
  <span class="dl">"</span><span class="s2">http.../js/a.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../js/a.js? _sw-precache=3cb4f0</span><span class="dl">"</span><span class="p">,</span>   
  <span class="dl">"</span><span class="s2">http.../css/b.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../css/b.css? _sw-precache=c5a951</span><span class="dl">"</span>  
<span class="p">}</span>

<span class="c1">// SW Network Logs  </span>
<span class="c1">// Empty</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="the-secondbuild">The second build</h3>

<p>Once we create a byte-diff of our subresouces (e.g., we modify <code class="language-plaintext highlighter-rouge">a.js</code> to a new version with hash value <code class="language-plaintext highlighter-rouge">d6420f</code>) and re-run the build process, a new version of <code class="language-plaintext highlighter-rouge">sw.js</code> would be also generated.</p>

<p>The new <code class="language-plaintext highlighter-rouge">sw.js</code> would run alongside with the existing one, and start its own installation phase.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c1">// cachedUrls  </span>
<span class="nc">Set</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  
  <span class="dl">"</span><span class="s2">http.../js/a.js? _sw-precache=3cb4f0</span><span class="dl">"</span><span class="p">,</span>   
  <span class="dl">"</span><span class="s2">http.../css/b.css? _sw-precache=c5a951</span><span class="dl">"</span>  
<span class="p">}</span>

<span class="c1">// urlToCacheKeys  </span>
<span class="nc">Map</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>  
  <span class="dl">"</span><span class="s2">http.../js/a.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../js/a.js? _sw-precache=d6420f</span><span class="dl">"</span><span class="p">,</span>   
  <span class="dl">"</span><span class="s2">http.../css/b.js</span><span class="dl">"</span> <span class="o">=&gt;</span> <span class="dl">"</span><span class="s2">http.../css/b.css? _sw-precache=c5a951</span><span class="dl">"</span>  
<span class="p">}</span>

<span class="c1">// SW Network Logs  </span>
 <span class="p">[</span><span class="nx">sw</span><span class="p">]</span> <span class="nx">GET</span> <span class="nx">a</span><span class="p">.</span><span class="nx">js</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="nx">d6420f</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This time, <code class="language-plaintext highlighter-rouge">sw.js</code> see that there is a new version of <code class="language-plaintext highlighter-rouge">a.js</code> requested, so it fetch <code class="language-plaintext highlighter-rouge">/js/a.js?_sw-precache=d6420f</code>  and put the response into cache. In fact, we have two versions of <code class="language-plaintext highlighter-rouge">a.js</code> in cache at the same time in this moment.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1">// what's in cache?</span>
<span class="nx">http</span><span class="p">...</span><span class="o">/</span><span class="nx">js</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">js</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="mi">3</span><span class="nx">cb4f0</span>
<span class="nx">http</span><span class="p">...</span><span class="o">/</span><span class="nx">js</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">js</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="nx">d6420f</span>
<span class="nx">http</span><span class="p">...</span><span class="o">/</span><span class="nx">css</span><span class="o">/</span><span class="nx">b</span><span class="p">.</span><span class="nx">css</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="nx">c5a951</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>By default, <code class="language-plaintext highlighter-rouge">sw.js</code> generated by sw-precache would call <code class="language-plaintext highlighter-rouge">self.skipWaiting</code> so it would take over the page and move onto activating phase immediately.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c1">// existingRequests</span>
<span class="nx">http</span><span class="p">...</span><span class="o">/</span><span class="nx">js</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">js</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="mi">3</span><span class="nx">cb4f0</span>
<span class="nx">http</span><span class="p">...</span><span class="o">/</span><span class="nx">js</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">js</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="nx">d6420f</span>
<span class="nx">http</span><span class="p">...</span><span class="o">/</span><span class="nx">css</span><span class="o">/</span><span class="nx">b</span><span class="p">.</span><span class="nx">css</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="nx">c5a951</span>

<span class="c1">// setOfExpectedUrls</span>
<span class="nc">Set</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
  <span class="dl">"</span><span class="s2">http.../js/a.js?_sw-precache=d6420f</span><span class="dl">"</span><span class="p">,</span> 
  <span class="dl">"</span><span class="s2">http.../css/b.css?_sw-precache=c5a951</span><span class="dl">"</span>
<span class="p">}</span>

<span class="c1">// the one deleted</span>
<span class="nx">http</span><span class="p">...</span><span class="o">/</span><span class="nx">js</span><span class="o">/</span><span class="nx">a</span><span class="p">.</span><span class="nx">js</span><span class="p">?</span><span class="nx">_sw</span><span class="o">-</span><span class="nx">precache</span><span class="o">=</span><span class="mi">3</span><span class="nx">cb4f0</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>By comparing existing requests in the cache with set of expected ones, the old version of <code class="language-plaintext highlighter-rouge">a.js</code> would be deleted from cache. This ensure there is only one version of our site’s resources each time.</p>

<p>That’s it! We finish the simulation successfully.</p>

<h2 id="conclusions">Conclusions</h2>

<p>As its name implied, sw-precache is designed specifically for the needs of precaching some critical static resources. It only does one thing but does it well. I’d love to give you some opinionated suggestions but you decide whether your requirements suit it or not.</p>

<h3 id="precaching-is-notfree">Precaching is NOT free</h3>

<p>So don’t precached everything. Sw-precache use a <a href="https://jakearchibald.com/2014/offline-cookbook/#on-install-as-a-dependency">“On Install — as a dependency”</a> strategy for your precache configs. A huge list of requests would delay the time service worker finishing installing and, in addition, wastes users’ bandwidth and disk space.</p>

<p>For instance, if you wanna build a offline-capable blogs. You had better not include things like <code class="language-plaintext highlighter-rouge">'posts/*.html</code> in <code class="language-plaintext highlighter-rouge">staticFileGlobs</code>. It would be a huge disaster to data-sensitive people if you have hundreds of posts. Use a Runtime Caching instead.</p>

<h3 id="app-shell">“App Shell”</h3>

<blockquote>
  <p>A helpful analogy is to think of your App Shell as the code and resources that would be published to an app store for a native iOS or Android application.</p>
</blockquote>

<p>Though I always consider that the term “App Shell” is too narrow to cover its actual usages now, It is widely used and commonly known. I personally prefer calling them <strong>“Web Installation Package”</strong> straightforward because they can be truly installed into users’ disks and our web app can boot up directly from them in any network environments. The only difference between “Web Installation Package” and iOS/Android App is that we need strive to limit it within a reasonable size.</p>

<p>Precaching is perfect for this kinda resources such as entry html, visual placeholders, offline pages etc., because they can be static in one version, small-sized, and most importantly, part of critical rendering path. We wanna put first meaningful paint ASAP to our user thus we precache them to eliminate HTTP roundtrip time.</p>

<p>BTW, if you are using HTML5 Application Cache before, sw-precache is really a perfect replacement because it can cover nearly all use cases the App Cache provide.</p>

<h3 id="this-is-not-theend">This is not the end</h3>

<p>Sw-precache is just one of awesome tools that can help you build service worker. If you are planing to add some service worker power into your website, Don’t hesitate to checkout sw-toolbox, sw-helper (a new tool Google is working on) and many more from communities.</p>

<p>That’s all. Wish you enjoy!</p>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/04/06/html-document/" data-toggle="tooltip" data-placement="top" title="如何理解 <code>document</code> 对象是 <code>HTMLDocument</code> 的实例？">
                        Previous<br>
                        <span>如何理解 <code>document</code> 对象是 <code>HTMLDocument</code> 的实例？</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/07/12/upgrading-eleme-to-pwa/" data-toggle="tooltip" data-placement="top" title="饿了么的 PWA 升级实践">
                        Next<br>
                        <span>饿了么的 PWA 升级实践</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0065" 
                    href="/archive/?tag=%E7%9F%A5%E4%B9%8E"
                    title="知乎"
                    rel="14">知乎</a>
        
                <a data-sort="0039" 
                    href="/archive/?tag=%E7%AC%94%E8%AE%B0"
                    title="笔记"
                    rel="40">笔记</a>
        
                <a data-sort="0043" 
                    href="/archive/?tag=Coq"
                    title="Coq"
                    rel="36">Coq</a>
        
                <a data-sort="0043" 
                    href="/archive/?tag=SF+%28%E8%BD%AF%E4%BB%B6%E5%9F%BA%E7%A1%80%29"
                    title="SF (软件基础)"
                    rel="36">SF (软件基础)</a>
        
                <a data-sort="0057" 
                    href="/archive/?tag=Web"
                    title="Web"
                    rel="22">Web</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=PLF+%28%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80%29"
                    title="PLF (编程语言基础)"
                    rel="19">PLF (编程语言基础)</a>
        
                <a data-sort="0063" 
                    href="/archive/?tag=LF+%28%E9%80%BB%E8%BE%91%E5%9F%BA%E7%A1%80%29"
                    title="LF (逻辑基础)"
                    rel="16">LF (逻辑基础)</a>
        
                <a data-sort="0071" 
                    href="/archive/?tag=PWA"
                    title="PWA"
                    rel="8">PWA</a>
        
                <a data-sort="0073" 
                    href="/archive/?tag=%E4%BA%A7%E5%93%81"
                    title="产品"
                    rel="6">产品</a>
        
                <a data-sort="0073" 
                    href="/archive/?tag=UX%2FUI"
                    title="UX/UI"
                    rel="6">UX/UI</a>
        
                <a data-sort="0075" 
                    href="/archive/?tag=JavaScript"
                    title="JavaScript"
                    rel="4">JavaScript</a>
        
                <a data-sort="0075" 
                    href="/archive/?tag=Meta"
                    title="Meta"
                    rel="4">Meta</a>
        
                <a data-sort="0075" 
                    href="/archive/?tag=Slides"
                    title="Slides"
                    rel="4">Slides</a>
        
                <a data-sort="0076" 
                    href="/archive/?tag=%E8%AF%91"
                    title="译"
                    rel="3">译</a>
        
                <a data-sort="0076" 
                    href="/archive/?tag=%E9%98%BF%E9%87%8C"
                    title="阿里"
                    rel="3">阿里</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=%E5%9F%BA%E7%A1%80"
                    title="基础"
                    rel="2">基础</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=%E5%BE%AE%E4%BF%A1"
                    title="微信"
                    rel="2">微信</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=%E8%AE%A1%E7%AE%97%E7%90%86%E8%AE%BA"
                    title="计算理论"
                    rel="2">计算理论</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=C"
                    title="C"
                    rel="2">C</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=C%2B%2B"
                    title="C++"
                    rel="2">C++</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=CSS"
                    title="CSS"
                    rel="2">CSS</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=En"
                    title="En"
                    rel="2">En</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=Vim"
                    title="Vim"
                    rel="2">Vim</a>
        
                <a data-sort="0077" 
                    href="/archive/?tag=hUX+%E9%9A%8F%E6%83%B3%E5%BD%95"
                    title="hUX 随想录"
                    rel="2">hUX 随想录</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="http://mida.re/">乱序（Midare）</a></li>
  
  <li><a href="https://ebnbin.dev/">Ebn Zhang</a></li>
  
  <li><a href="http://kunq.me">Kun Qian</a></li>
  
  <li><a href="https://sherrywoo.me/">Sherry Woo</a></li>
  
  <li><a href="http://blog.smdcn.net">SmdCn</a></li>
  
  <li><a href="http://tiye.me/">JiyinYiyong</a></li>
  
  <li><a href="http://dhong.co">DHong Say</a></li>
  
  <li><a href="http://ingf.github.io/">尹峰以为</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "hux";
    var disqus_identifier = "/2017/05/28/sw-precache";
    var disqus_url = "http://localhost:4000/2017/05/28/sw-precache/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="http://weibo.com/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://github.com/huxpro">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Hux Blog 2023
                    <br>
                    Powered by <a href="http://huangxuan.me">Hux Blog</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'huangxuan.me';

    // Originial
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
